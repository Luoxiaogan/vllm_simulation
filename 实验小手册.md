# 实验小手册

## 快速开始：状态保存与加载

### Step 1: 运行实验并保存状态
```bash
python experiments/run_advanced_with_generation.py --config config/step1_save_state.yaml
```
记录输出的实验目录，例如：`data/experiments/experiment_20250826_012102_6168/`

### Step 2: 从状态恢复
编辑 `config/step2_load_state.yaml`，修改第7行的路径：
```yaml
state_file: "data/experiments/experiment_20250826_012102_6168/states/state_batch_3100.csv"
```

运行：
```bash
python experiments/run_advanced_with_generation.py --config config/step2_load_state.yaml
```

## 三种使用模式

### 模式1：只完成已有请求
```yaml
# config/step2_load_state.yaml 中修改：
initial_state:
  continue_generation: false
generation:
  enabled: false
```

### 模式2：继续生成新请求
```yaml
# config/step2_load_state.yaml 中修改：
initial_state:
  continue_generation: true
generation:
  enabled: true
  num_requests: 5000  # 新增请求数
```

### 模式3：从零开始（不加载状态）
```bash
python experiments/run_advanced_with_generation.py --config config/step1_save_state.yaml
```

## 查看保存的状态
```bash
# 查看状态文件
ls data/experiments/experiment_*/states/

# 查看状态详情（前20行）
head -20 data/experiments/experiment_*/states/state_batch_3100.csv

# 统计状态分布
grep -v "^#" data/experiments/experiment_*/states/state_batch_3100.csv | \
  awk -F',' 'NR>1 {print $2}' | sort | uniq -c
```

## 常用参数说明

| 参数 | 含义 | 示例值 |
|------|------|--------|
| `generation.num_requests` | 生成请求数 | 20000 |
| `state_save.batch_ids` | 保存状态的批次 | [3000, 3100] |
| `initial_state.continue_generation` | 是否继续生成 | true/false |
| `control.preemption_mode` | 抢占模式 | sacrifice/swap |
| `control.preemption_strategy` | 抢占策略 | aggressive/conservative |

## 完整工作流示例

```bash
# 1. 第一次运行，保存状态
python experiments/run_advanced_with_generation.py --config config/step1_save_state.yaml
# 输出: data/experiments/experiment_20250826_012102_6168/

# 2. 查看保存的状态
ls data/experiments/experiment_20250826_012102_6168/states/
# 显示: state_batch_3000.csv  state_batch_3100.csv

# 3. 修改配置文件
vim config/step2_load_state.yaml
# 修改 state_file 路径

# 4. 从批次3100恢复并继续
python experiments/run_advanced_with_generation.py --config config/step2_load_state.yaml

# 5. 查看结果
ls data/experiments/experiment_20250826_012349_3111/
```

## 注意事项

1. **路径替换**：运行Step 2前必须修改 `state_file` 路径
2. **类型一致**：建议保持 `types` 参数相同
3. **批次选择**：选择系统稳定的批次保存（避免过早或过晚）
4. **内存检查**：加载状态时会自动验证内存约束

## 调试技巧

```bash
# 检查实验是否到达保存点
grep "批次" data/experiments/*/summary.txt

# 查看活跃请求数量
grep -v "^#\|completed" data/experiments/*/states/state_batch_*.csv | wc -l

# 验证时间归一化
grep "系统初始时间" data/experiments/*/logs/*.log
```